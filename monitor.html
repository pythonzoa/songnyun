<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ë°©íƒˆì¶œ ê²Œì„ - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„° (ê°•í™”íŒ)</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}

/* í…Œë§ˆ ë³€ìˆ˜ */
:root {
    --bg-gradient-start: #667eea;
    --bg-gradient-end: #764ba2;
    --container-bg: white;
    --text-primary: #333;
    --text-secondary: #666;
    --card-bg: white;
    --table-border: #ddd;
    --table-hover: #f9f9f9;
    --shadow: rgba(0,0,0,0.3);
    --activity-bg: #f8f9fa;
}

body.dark-mode {
    --bg-gradient-start: #1a1a2e;
    --bg-gradient-end: #16213e;
    --container-bg: #0f3460;
    --text-primary: #eee;
    --text-secondary: #aaa;
    --card-bg: #1a1a2e;
    --table-border: #2d3748;
    --table-hover: #2d3748;
    --shadow: rgba(0,0,0,0.6);
    --activity-bg: #1a202c;
}

body.neon-mode {
    --bg-gradient-start: #0a0e27;
    --bg-gradient-end: #1a1a3e;
    --container-bg: #0d1117;
    --text-primary: #00ff9f;
    --text-secondary: #00d4ff;
    --card-bg: #161b22;
    --table-border: #00ff9f;
    --table-hover: #1a2332;
    --shadow: rgba(0,255,159,0.3);
    --activity-bg: #161b22;
}

body.pastel-mode {
    --bg-gradient-start: #ffecd2;
    --bg-gradient-end: #fcb69f;
    --container-bg: #fff;
    --text-primary: #5a5a5a;
    --text-secondary: #8a8a8a;
    --card-bg: #fff;
    --table-border: #ffe4e1;
    --table-hover: #fff0f5;
    --shadow: rgba(252,182,159,0.3);
    --activity-bg: #fff5f5;
}

body{
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
    min-height:100vh;
    padding:20px;
    transition: all 0.5s ease;
}

.main-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 20px;
    max-width: 1600px;
    margin: 0 auto;
}

@media (max-width: 1200px) {
    .main-grid {
        grid-template-columns: 1fr;
    }
}

.container{
    background: var(--container-bg);
    border-radius:20px;
    box-shadow:0 20px 60px var(--shadow);
    padding:30px;
    transition: all 0.5s ease;
}

.sidebar {
    background: var(--container-bg);
    border-radius:20px;
    box-shadow:0 20px 60px var(--shadow);
    padding:30px;
    transition: all 0.5s ease;
    position: sticky;
    top: 20px;
    height: fit-content;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

h1{
    text-align:center;
    color:#667eea;
    margin-bottom:10px;
    font-size:2em;
    transition: color 0.5s ease;
}

body.dark-mode h1 { color: #8b9cff; }
body.neon-mode h1 { color: #00ff9f; text-shadow: 0 0 20px #00ff9f; }
body.pastel-mode h1 { color: #ff9a9e; }

.subtitle{
    text-align:center;
    color: var(--text-secondary);
    margin-bottom:20px;
    font-size:1.1em;
    font-weight:bold;
}

/* í…Œë§ˆ ì»¨íŠ¸ë¡¤ */
.theme-controls {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.theme-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.theme-btn.light { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
.theme-btn.dark { background: linear-gradient(135deg, #1a1a2e, #16213e); color: #8b9cff; }
.theme-btn.neon { background: linear-gradient(135deg, #0a0e27, #1a1a3e); color: #00ff9f; border: 2px solid #00ff9f; }
.theme-btn.pastel { background: linear-gradient(135deg, #ffecd2, #fcb69f); color: #5a5a5a; }

.theme-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.theme-btn.active { box-shadow: 0 0 0 3px rgba(102,126,234,0.3); }

/* ê²€ìƒ‰ ë° í•„í„° */
.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.search-box {
    flex: 1;
    min-width: 200px;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 10px 35px 10px 12px;
    border: 2px solid var(--table-border);
    border-radius: 8px;
    font-size: 0.95em;
    transition: all 0.3s;
    background: var(--card-bg);
    color: var(--text-primary);
}

.search-box input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
}

.search-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.filter-btn {
    padding: 8px 16px;
    border: 2px solid #667eea;
    background: var(--card-bg);
    color: #667eea;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 600;
    font-size: 0.9em;
}

.filter-btn:hover { background: #667eea; color: white; }
.filter-btn.active { background: #667eea; color: white; }

body.neon-mode .filter-btn { border-color: #00ff9f; color: #00ff9f; }
body.neon-mode .filter-btn:hover, body.neon-mode .filter-btn.active { background: #00ff9f; color: #0a0e27; }

/* ì• ë‹ˆë©”ì´ì…˜ */
@keyframes pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
    50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(102, 126, 234, 0); }
}

@keyframes countUp {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateX(-100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.stats{
    display:flex;
    gap:15px;
    flex-wrap:wrap;
    margin-bottom:20px;
}

.stat-card{
    flex:1;
    min-width:140px;
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:white;
    padding:18px;
    border-radius:12px;
    text-align:center;
    transition:all 0.3s;
    cursor: pointer;
}

.stat-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
.stat-card h3{font-size:2em;margin-bottom:5px}
.stat-card.stage1{background:linear-gradient(135deg,#f093fb,#f5576c)}
.stat-card.stage2{background:linear-gradient(135deg,#4facfe,#00f2fe)}
.stat-card.stage3{background:linear-gradient(135deg,#43e97b,#38f9d7)}

.stat-card.pulse { animation: pulse 0.6s ease-in-out; }
.stat-card h3.counting { animation: countUp 0.5s ease-out; }

body.dark-mode .stat-card { background: linear-gradient(135deg, #2d3748, #1a202c); }
body.dark-mode .stat-card.stage1 { background: linear-gradient(135deg, #702459, #c53030); }
body.dark-mode .stat-card.stage2 { background: linear-gradient(135deg, #2c5282, #2b6cb0); }
body.dark-mode .stat-card.stage3 { background: linear-gradient(135deg, #276749, #2f855a); }

body.neon-mode .stat-card { background: transparent; border: 2px solid #00ff9f; box-shadow: 0 0 20px rgba(0,255,159,0.3); }
body.neon-mode .stat-card.stage1 { border-color: #ff006e; box-shadow: 0 0 20px rgba(255,0,110,0.3); }
body.neon-mode .stat-card.stage2 { border-color: #00d4ff; box-shadow: 0 0 20px rgba(0,212,255,0.3); }
body.neon-mode .stat-card.stage3 { border-color: #00ff9f; box-shadow: 0 0 20px rgba(0,255,159,0.5); }

/* í™œë™ í”¼ë“œ */
.activity-feed {
    background: var(--activity-bg);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.activity-feed h3 {
    margin: 0 0 15px 0;
    color: var(--text-primary);
}

.activity-list {
    max-height: 400px;
    overflow-y: auto;
}

.activity-item {
    background: var(--card-bg);
    padding: 12px 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    animation: slideInRight 0.4s ease-out;
}

.activity-item.stage1 { border-left-color: #f093fb; }
.activity-item.stage2 { border-left-color: #4facfe; }
.activity-item.stage3 { border-left-color: #43e97b; }

.activity-time {
    font-size: 0.85em;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.activity-message {
    color: var(--text-primary);
    font-weight: 500;
}

.activity-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin-left: 5px;
}

.badge-stage1 { background: #ffe6f0; color: #f5576c; }
.badge-stage2 { background: #e0f7ff; color: #00a8e8; }
.badge-stage3 { background: #d4f4dd; color: #38b2ac; }

body.dark-mode .badge-stage1 { background: #702459; color: #ffb3d9; }
body.dark-mode .badge-stage2 { background: #2c5282; color: #90cdf4; }
body.dark-mode .badge-stage3 { background: #276749; color: #9ae6b4; }

/* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    animation: toastIn 0.4s ease-out;
    border-left: 4px solid #43e97b;
    max-width: 350px;
    color: #333;
}

body.dark-mode .toast {
    background: #2d3748;
    color: #eee;
}

body.neon-mode .toast {
    background: #161b22;
    color: #00ff9f;
    box-shadow: 0 0 20px rgba(0,255,159,0.3);
}

@media (max-width: 768px) {
    .toast {
        right: 10px;
        left: 10px;
        max-width: none;
    }
}

@keyframes toastIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.toast.hiding {
    animation: toastOut 0.4s ease-out forwards;
}

@keyframes toastOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}

.table{
    width:100%;
    border-collapse:collapse;
    margin:10px 0 20px 0;
}

.table th,.table td{
    border:2px solid var(--table-border);
    padding:8px 10px;
    text-align:center;
    transition:background 0.3s;
}

.table th{
    background:#667eea;
    color:white;
    cursor:pointer;
    user-select:none;
}

.table th:hover{background:#5568d3}

body.dark-mode .table th { background: #2d3748; }
body.neon-mode .table th { background: transparent; border: 2px solid #00ff9f; color: #00ff9f; }
body.pastel-mode .table th { background: #ffb3ba; color: #5a5a5a; }

.table tr:nth-child(even){background: var(--table-hover)}
.table tbody tr{cursor:pointer;transition:all 0.3s; animation: fadeIn 0.5s ease-out;}
.table tbody tr:hover{background:#e3f2fd;transform:scale(1.01)}
.table tbody tr.new-entry {
    animation: slideIn 0.6s ease-out;
    background: #ffffcc !important;
}

body.dark-mode .table tbody tr:hover { background: #374151; }
body.neon-mode .table tbody tr:hover { background: #1a2332; box-shadow: 0 0 10px rgba(0,255,159,0.2); }

h3{margin-top:20px;margin-bottom:8px;color: var(--text-primary);transition: color 0.5s ease;}
h4{margin-top:15px;margin-bottom:5px;color: var(--text-secondary);transition: color 0.5s ease;}
.small{font-size:0.85em;color: var(--text-secondary);}
#connStatus{margin-bottom:10px;font-size:0.9em;text-align:right;color: var(--text-secondary);}
.conn-ok{color:#c8e6c9;}
.conn-error{color:#ffccbc;}

.btn-retry{
    padding:12px 30px;
    font-size:1em;
    font-weight:bold;
    color:white;
    background:linear-gradient(135deg,#f093fb,#f5576c);
    border:none;
    border-radius:12px;
    cursor:pointer;
    box-shadow:0 8px 20px rgba(240,147,251,0.4);
    transition:all 0.3s;
}

.btn-retry:hover{transform:translateY(-3px);box-shadow:0 12px 25px rgba(240,147,251,0.5);}

/* ëª¨ë‹¬ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal.show { display: flex; }

.modal-content {
    background: var(--container-bg);
    border-radius: 16px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: modalIn 0.3s ease-out;
    color: var(--text-primary);
}

@keyframes modalIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h2 {
    color: #667eea;
    margin: 0;
}

body.neon-mode .modal-header h2 { color: #00ff9f; }

.modal-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: var(--text-secondary);
    line-height: 1;
}

.modal-close:hover { color: var(--text-primary); }

.modal-info {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.modal-label {
    font-weight: 600;
    color: var(--text-secondary);
}

.modal-value {
    color: var(--text-primary);
}

.progress-section {
    margin-top: 20px;
}

.progress-stage {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.stage-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    background: #ccc;
}

.stage-circle.completed { background: #43e97b; }
.stage-circle.current { background: #667eea; }

.stage-info {
    flex: 1;
}

.stage-name {
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-primary);
}

.stage-time {
    font-size: 0.9em;
    color: var(--text-secondary);
}
</style>
</head>
<body>
<div class="main-grid">
    <div class="container">
        <h1>ğŸ”Š ë°©íƒˆì¶œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</h1>
        <div class="subtitle">ì°¸ê°€ì ì§„í–‰ìƒí™© í•œëˆˆì— ë³´ê¸°</div>

        <div class="theme-controls">
            <button class="theme-btn light active" onclick="setTheme('light')">â˜€ï¸ ë¼ì´íŠ¸</button>
            <button class="theme-btn dark" onclick="setTheme('dark')">ğŸŒ™ ë‹¤í¬</button>
            <button class="theme-btn neon" onclick="setTheme('neon')">âš¡ ë„¤ì˜¨</button>
            <button class="theme-btn pastel" onclick="setTheme('pastel')">ğŸŒ¸ íŒŒìŠ¤í…”</button>
        </div>

        <div style="text-align:center;margin-bottom:20px;">
            <button class="btn-retry" onclick="location.href='escape-room-game.html'">ğŸ® ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
        </div>

        <div id="connStatus">â³ Firebase ì—°ê²° ì‹œë„ ì¤‘...</div>

        <div class="stats">
            <div class="stat-card" onclick="filterByStage('all')">
                <h3 id="totalPlayers">0</h3>
                <p>ì „ì²´ ì°¸ê°€ì</p>
            </div>
            <div class="stat-card stage1" onclick="filterByStage(1)">
                <h3 id="stage1Count">0</h3>
                <p>1ë‹¨ê³„ í†µê³¼</p>
            </div>
            <div class="stat-card stage2" onclick="filterByStage(2)">
                <h3 id="stage2Count">0</h3>
                <p>2ë‹¨ê³„ í†µê³¼</p>
            </div>
            <div class="stat-card stage3" onclick="filterByStage(3)">
                <h3 id="stage3Count">0</h3>
                <p>ğŸ† 3ë‹¨ê³„ í†µê³¼</p>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="searchPlayers()">
                <span class="search-icon">ğŸ”</span>
            </div>
            <button class="filter-btn active" onclick="sortTable('name')">ì´ë¦„ìˆœ</button>
            <button class="filter-btn" onclick="sortTable('stage')">ì§„í–‰ë„ìˆœ</button>
            <button class="filter-btn" onclick="sortTable('time')">ì‹œê°„ìˆœ</button>
        </div>

        <h3>ğŸ“‹ ì§„í–‰ ë‹¨ê³„ í˜„í™©</h3>
        <p class="small">ê° í‘œì˜ ì‹œê°„ì€ í•´ë‹¹ ë‹¨ê³„ì— <strong>ë§ˆì§€ë§‰ìœ¼ë¡œ ë„ë‹¬í•œ ì‹œê°</strong>(HH:MM)ì…ë‹ˆë‹¤. í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</p>

        <h4>1ë‹¨ê³„ í†µê³¼ì</h4>
        <table class="table">
            <thead>
                <tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì™„ë£Œ ì‹œê°„</th></tr>
            </thead>
            <tbody id="stage1Body">
                <tr><td colspan="3">ì—†ìŒ</td></tr>
            </tbody>
        </table>

        <h4>2ë‹¨ê³„ í†µê³¼ì</h4>
        <table class="table">
            <thead>
                <tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì™„ë£Œ ì‹œê°„</th></tr>
            </thead>
            <tbody id="stage2Body">
                <tr><td colspan="3">ì—†ìŒ</td></tr>
            </tbody>
        </table>

        <h4>ğŸ† 3ë‹¨ê³„ í†µê³¼ì ğŸ†</h4>
        <table class="table">
            <thead>
                <tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì™„ë£Œ ì‹œê°„</th></tr>
            </thead>
            <tbody id="stage3Body">
                <tr><td colspan="3">ì—†ìŒ</td></tr>
            </tbody>
        </table>
    </div>

    <!-- ì‚¬ì´ë“œë°” - í™œë™ í”¼ë“œ -->
    <div class="sidebar">
        <div class="activity-feed">
            <h3>âš¡ ì‹¤ì‹œê°„ í™œë™</h3>
            <div class="activity-list" id="activityList">
                <p class="small" style="text-align:center;padding:20px;">í™œë™ ëŒ€ê¸° ì¤‘...</p>
            </div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="playerModal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="modalTitle">ì°¸ê°€ì ì •ë³´</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-info">
            <div class="modal-label">ì´ë¦„:</div>
            <div class="modal-value" id="modalName">-</div>
            <div class="modal-label">í˜„ì¬ ë‹¨ê³„:</div>
            <div class="modal-value" id="modalStage">-</div>
            <div class="modal-label">ì°¸ì—¬ ì‹œê°„:</div>
            <div class="modal-value" id="modalJoinTime">-</div>
            <div class="modal-label">ìµœê·¼ í™œë™:</div>
            <div class="modal-value" id="modalLastUpdate">-</div>
        </div>
        <div class="progress-section">
            <h3 style="margin-bottom:15px">ì§„í–‰ ë‹¨ê³„</h3>
            <div class="progress-stage">
                <div class="stage-circle" id="circle1">1</div>
                <div class="stage-info">
                    <div class="stage-name">1ë‹¨ê³„ - ì²« ë²ˆì§¸ í¼ì¦</div>
                    <div class="stage-time" id="stage1Time">ëŒ€ê¸° ì¤‘</div>
                </div>
            </div>
            <div class="progress-stage">
                <div class="stage-circle" id="circle2">2</div>
                <div class="stage-info">
                    <div class="stage-name">2ë‹¨ê³„ - ì•”í˜¸ í•´ë…</div>
                    <div class="stage-time" id="stage2Time">ëŒ€ê¸° ì¤‘</div>
                </div>
            </div>
            <div class="progress-stage">
                <div class="stage-circle" id="circle3">3</div>
                <div class="stage-info">
                    <div class="stage-name">3ë‹¨ê³„ - ìµœì¢… íƒˆì¶œ</div>
                    <div class="stage-time" id="stage3Time">ëŒ€ê¸° ì¤‘</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    var firebaseConfig = {
        apiKey: "AIzaSyBeC5C9NYZVO3c5MZrTeUfpFjCnW059bDQ",
        authDomain: "selab-party.firebaseapp.com",
        databaseURL: "https://selab-party-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "selab-party"
    };
    var db = null;
    var allPlayers = {};
    var currentFilter = 'all';
    var activityCount = 0;
    var isInitialLoad = true;
    var previousPlayerStages = {}; // ì´ì „ í”Œë ˆì´ì–´ ë‹¨ê³„ ì €ì¥

    function init() {
        var connStatus = document.getElementById("connStatus");
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            connStatus.textContent = "âœ… Firebase ì—°ê²°ë¨";
            connStatus.classList.add("conn-ok");
            setupListeners();
        } catch (e) {
            connStatus.textContent = "âŒ Firebase ì—°ê²° ì‹¤íŒ¨: " + e.message;
            connStatus.classList.add("conn-error");
        }
    }

    function formatTime(isoString) {
        if (!isoString) return "-";
        var d = new Date(isoString);
        if (isNaN(d.getTime())) return "-";
        var h = d.getHours();
        var m = String(d.getMinutes()).padStart(2, "0");
        return h + ":" + m;
    }

    function animateNumber(elementId, newValue) {
        const el = document.getElementById(elementId);
        el.classList.add('counting');
        el.textContent = newValue;
        setTimeout(() => el.classList.remove('counting'), 500);
    }

    function pulseCard(cardClass) {
        const cards = document.querySelectorAll('.stat-card.' + cardClass);
        cards.forEach(card => {
            card.classList.add('pulse');
            setTimeout(() => card.classList.remove('pulse'), 600);
        });
    }

    function showToast(message, stage) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        
        // stageì— ë”°ë¼ ìƒ‰ìƒ ì„¤ì •
        if (stage === 3) {
            toast.style.borderLeftColor = '#43e97b';
        } else if (stage === 2) {
            toast.style.borderLeftColor = '#4facfe';
        } else if (stage === 1) {
            toast.style.borderLeftColor = '#f093fb';
        } else {
            // stage 0 (ìƒˆ ì°¸ê°€ì)
            toast.style.borderLeftColor = '#667eea';
        }
        
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 400);
        }, 4000);
    }

    function addActivityItem(name, stage, time) {
        const activityList = document.getElementById('activityList');
        
        // ì²« í™œë™ì´ë©´ placeholder ì œê±°
        if (activityCount === 0) {
            activityList.innerHTML = '';
        }
        
        const item = document.createElement('div');
        
        let emoji, message, badgeClass, badgeText, itemClass;
        
        if (stage === 0) {
            // ìƒˆ ì°¸ê°€ì
            emoji = 'ğŸ‘‹';
            message = 'ê²Œì„ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤';
            badgeClass = 'badge-stage1';
            badgeText = 'ì‹œì‘';
            itemClass = 'activity-item';
        } else if (stage === 3) {
            emoji = 'ğŸ‰';
            message = 'ëª¨ë“  ë‹¨ê³„ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!';
            badgeClass = 'badge-stage3';
            badgeText = '3ë‹¨ê³„';
            itemClass = 'activity-item stage3';
        } else if (stage === 2) {
            emoji = 'âœ¨';
            message = '2ë‹¨ê³„ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤';
            badgeClass = 'badge-stage2';
            badgeText = '2ë‹¨ê³„';
            itemClass = 'activity-item stage2';
        } else {
            emoji = 'ğŸš€';
            message = '1ë‹¨ê³„ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤';
            badgeClass = 'badge-stage1';
            badgeText = '1ë‹¨ê³„';
            itemClass = 'activity-item stage1';
        }
        
        item.className = itemClass;
        item.innerHTML = `
            <div class="activity-time">${time}</div>
            <div class="activity-message">
                ${emoji} <strong>${name}</strong>ë‹˜ì´ ${message}
                <span class="activity-badge ${badgeClass}">${badgeText}</span>
            </div>
        `;
        
        activityList.insertBefore(item, activityList.firstChild);
        activityCount++;
        
        // 20ê°œ ì´ìƒì´ë©´ ì œê±°
        if (activityList.children.length > 20) {
            activityList.removeChild(activityList.lastChild);
        }
        
        // í† ìŠ¤íŠ¸ ì•Œë¦¼
        showToast(`${emoji} <strong>${name}</strong>ë‹˜ì´ ${message}`, stage);
    }

    function setupListeners() {
        if (!db) return;

        // ì´ˆê¸° ë°ì´í„° ë¡œë”©
        db.ref("players").once("value", function(s) {
            var d = s.val();
            if (d) {
                for (var k in d) {
                    var p = d[k];
                    previousPlayerStages[k] = p.stage || 0;
                }
            }
            // ì´ˆê¸° ë¡œë”© ì™„ë£Œ í›„ ì‹¤ì‹œê°„ ê°ì§€ ì‹œì‘
            setTimeout(function() {
                isInitialLoad = false;
            }, 1000);
        });

        // í”Œë ˆì´ì–´ ë‹¨ê³„ ë³€ê²½ ê°ì§€ (ì‹¤ì‹œê°„ ì•Œë¦¼ìš©)
        db.ref("players").on("child_changed", function(snapshot) {
            if (isInitialLoad) return;
            
            var player = snapshot.val();
            var playerKey = snapshot.key;
            var newStage = player.stage || 0;
            var oldStage = previousPlayerStages[playerKey] || 0;
            
            // ë‹¨ê³„ê°€ ì¦ê°€í•œ ê²½ìš°ì—ë§Œ ì•Œë¦¼
            if (newStage > oldStage && newStage > 0) {
                var time = formatTime(player.lastUpdate || player.joinedAt);
                addActivityItem(player.name, newStage, time);
                
                // í•´ë‹¹ ë‹¨ê³„ ì¹´ë“œì— í„ìŠ¤ íš¨ê³¼
                if (newStage === 1) pulseCard('stage1');
                else if (newStage === 2) pulseCard('stage2');
                else if (newStage === 3) pulseCard('stage3');
            }
            
            // ì´ì „ ë‹¨ê³„ ì—…ë°ì´íŠ¸
            previousPlayerStages[playerKey] = newStage;
        });

        // ìƒˆ í”Œë ˆì´ì–´ ì¶”ê°€ ê°ì§€
        db.ref("players").on("child_added", function(snapshot) {
            if (isInitialLoad) return;
            
            var player = snapshot.val();
            var playerKey = snapshot.key;
            previousPlayerStages[playerKey] = player.stage || 0;
            
            // ìƒˆ ì°¸ê°€ì ì•Œë¦¼ (ì‹œì‘ ì‹œì—ë§Œ)
            if ((player.stage || 0) === 0) {
                var time = formatTime(player.joinedAt);
                addActivityItem(player.name, 0, time);
            }
        });

        // ì „ì²´ ë°ì´í„° ì—…ë°ì´íŠ¸ (í…Œì´ë¸” ë Œë”ë§ìš©)
        db.ref("players").on("value", function(s) {
            var d = s.val();
            allPlayers = d || {};
            
            var stage1Body = document.getElementById("stage1Body");
            var stage2Body = document.getElementById("stage2Body");
            var stage3Body = document.getElementById("stage3Body");

            if (!d) {
                animateNumber('totalPlayers', 0);
                animateNumber('stage1Count', 0);
                animateNumber('stage2Count', 0);
                animateNumber('stage3Count', 0);
                stage1Body.innerHTML = '<tr><td colspan="3">ì—†ìŒ</td></tr>';
                stage2Body.innerHTML = '<tr><td colspan="3">ì—†ìŒ</td></tr>';
                stage3Body.innerHTML = '<tr><td colspan="3">ì—†ìŒ</td></tr>';
                return;
            }

            var totalPlayers = 0;
            var stage1List = [];
            var stage2List = [];
            var stage3List = [];

            for (var k in d) {
                var p = d[k];
                p.key = k;
                totalPlayers++;
                var stage = p.stage || 0;
                if (stage === 1) stage1List.push(p);
                else if (stage === 2) stage2List.push(p);
                else if (stage === 3) stage3List.push(p);
            }

            animateNumber('totalPlayers', totalPlayers);
            animateNumber('stage1Count', stage1List.length);
            animateNumber('stage2Count', stage2List.length);
            animateNumber('stage3Count', stage3List.length);

            function sortByTime(list) {
                list.sort(function(a,b){
                    var ta = a.lastUpdate || a.joinedAt || '';
                    var tb = b.lastUpdate || b.joinedAt || '';
                    return new Date(ta) - new Date(tb);
                });
            }
            sortByTime(stage1List);
            sortByTime(stage2List);
            sortByTime(stage3List);

            function renderStage(bodyEl, list, stage) {
                if (!list.length) {
                    bodyEl.innerHTML = '<tr><td colspan="3">ì—†ìŒ</td></tr>';
                    return;
                }
                var _h = "";
                for (var i=0;i<list.length;i++) {
                    var p = list[i];
                    var tIso = p.lastUpdate || p.joinedAt || "";
                    var timeText = formatTime(tIso);
                    _h += '<tr onclick="showPlayerDetail(\'' + p.key + '\')">' +
                          '<td>' + (i+1) + '</td>' +
                          '<td>' + (p.name || '-') + '</td>' +
                          '<td>' + timeText + '</td>' +
                          '</tr>';
                }
                bodyEl.innerHTML = _h;
            }

            renderStage(stage1Body, stage1List, 1);
            renderStage(stage2Body, stage2List, 2);
            renderStage(stage3Body, stage3List, 3);

            // í•„í„° ì ìš©
            if (currentFilter !== 'all') {
                filterByStage(currentFilter);
            }
        });
    }

    function showPlayerDetail(playerKey) {
        const player = allPlayers[playerKey];
        if (!player) return;
        
        const stage = player.stage || 0;
        
        document.getElementById('modalName').textContent = player.name || '-';
        document.getElementById('modalStage').textContent = stage + 'ë‹¨ê³„';
        document.getElementById('modalJoinTime').textContent = formatTime(player.joinedAt);
        document.getElementById('modalLastUpdate').textContent = formatTime(player.lastUpdate);
        
        // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
        const circles = ['circle1', 'circle2', 'circle3'];
        circles.forEach((id, idx) => {
            const circle = document.getElementById(id);
            circle.className = 'stage-circle';
            if (idx < stage) {
                circle.classList.add('completed');
            } else if (idx === stage) {
                circle.classList.add('current');
            }
        });
        
        // ì‹œê°„ ì—…ë°ì´íŠ¸
        document.getElementById('stage1Time').textContent = stage >= 1 ? 'ì™„ë£Œ: ' + formatTime(player.lastUpdate) : 'ëŒ€ê¸° ì¤‘';
        document.getElementById('stage2Time').textContent = stage >= 2 ? 'ì™„ë£Œ: ' + formatTime(player.lastUpdate) : stage === 1 ? 'ì§„í–‰ ì¤‘...' : 'ëŒ€ê¸° ì¤‘';
        document.getElementById('stage3Time').textContent = stage >= 3 ? 'ì™„ë£Œ: ' + formatTime(player.lastUpdate) : stage === 2 ? 'ì§„í–‰ ì¤‘...' : 'ëŒ€ê¸° ì¤‘';
        
        document.getElementById('playerModal').classList.add('show');
    }

    function closeModal(event) {
        if (!event || event.target.className === 'modal show') {
            document.getElementById('playerModal').classList.remove('show');
        }
    }

    function filterByStage(stage) {
        currentFilter = stage;
        const tables = ['stage1Body', 'stage2Body', 'stage3Body'];
        
        if (stage === 'all') {
            tables.forEach(tableId => {
                const rows = document.getElementById(tableId).querySelectorAll('tr');
                rows.forEach(row => row.style.display = '');
            });
            return;
        }
        
        // ì„ íƒí•œ ë‹¨ê³„ë§Œ í‘œì‹œ
        tables.forEach((tableId, idx) => {
            const stageNum = idx + 1;
            const rows = document.getElementById(tableId).querySelectorAll('tr');
            rows.forEach(row => {
                if (stageNum === stage) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    function searchPlayers() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const tables = ['stage1Body', 'stage2Body', 'stage3Body'];
        
        tables.forEach(tableId => {
            const rows = document.getElementById(tableId).querySelectorAll('tr');
            rows.forEach(row => {
                const nameCell = row.cells[1];
                if (nameCell) {
                    const name = nameCell.textContent.toLowerCase();
                    if (name.includes(input)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });
    }

    function sortTable(column) {
        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Firebaseì—ì„œ ë‹¤ì‹œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì •ë ¬ (ì‹¤ì œë¡œëŠ” ì´ë¯¸ ì •ë ¬ë˜ì–´ ìˆìŒ)
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì‹œê°ì  í”¼ë“œë°±ë§Œ ì œê³µ
    }

    function setTheme(theme) {
        document.body.classList.remove('dark-mode', 'neon-mode', 'pastel-mode');
        
        if (theme !== 'light') {
            document.body.classList.add(theme + '-mode');
        }
        
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        localStorage.setItem('theme', theme);
    }

    window.onload = function() {
        // ì €ì¥ëœ í…Œë§ˆ ì ìš©
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme && savedTheme !== 'light') {
            document.body.classList.add(savedTheme + '-mode');
            document.querySelector(`.theme-btn.${savedTheme}`).classList.add('active');
            document.querySelector('.theme-btn.light').classList.remove('active');
        }
        
        setTimeout(init, 200);
    };
</script>
</body>
</html>
