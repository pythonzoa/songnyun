<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ë°©íƒˆì¶œ ê²Œì„ - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
.container{background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:1200px;margin:0 auto;padding:30px}
h1{text-align:center;color:#667eea;margin-bottom:10px;font-size:2em}
.subtitle{text-align:center;color:#f093fb;margin-bottom:25px;font-size:1.1em;font-weight:bold}
.stats{display:flex;gap:15px;flex-wrap:wrap;margin-bottom:20px}
.stat-card{flex:1;min-width:140px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:18px;border-radius:12px;text-align:center}
.stat-card h3{font-size:2em;margin-bottom:5px}
.stat-card.stage1{background:linear-gradient(135deg,#f093fb,#f5576c)}
.stat-card.stage2{background:linear-gradient(135deg,#4facfe,#00f2fe)}
.stat-card.stage3{background:linear-gradient(135deg,#43e97b,#38f9d7)}
.table{width:100%;border-collapse:collapse;margin:10px 0 20px 0}
.table th,.table td{border:2px solid #ddd;padding:8px 10px;text-align:center}
.table th{background:#667eea;color:white}
.table tr:nth-child(even){background:#f9f9f9}
h3{margin-top:20px;margin-bottom:8px;color:#333}
h4{margin-top:15px;margin-bottom:5px;color:#444}
.small{font-size:0.85em;color:#666}
#connStatus{margin-bottom:10px;font-size:0.9em;text-align:right;color:#fff;}
.conn-ok{color:#c8e6c9;}
.conn-error{color:#ffccbc;}
.btn-retry{padding:15px 40px;font-size:1.2em;font-weight:bold;color:white;background:linear-gradient(135deg,#f093fb,#f5576c);border:none;border-radius:12px;cursor:pointer;box-shadow:0 8px 20px rgba(240,147,251,0.4);transition:all 0.3s;}
.btn-retry:hover{transform:translateY(-3px);box-shadow:0 12px 25px rgba(240,147,251,0.5);}
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ“Š ë°©íƒˆì¶œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</h1>
    <div class="subtitle">ì°¸ê°€ì ì§„í–‰ìƒí™© í•œëˆˆì— ë³´ê¸°</div>

    <div style="text-align:center;margin-bottom:20px;">
        <button class="btn-retry" onclick="location.href='escape-room-game.html'">ğŸ® ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
    </div>

    <div id="connStatus">â³ Firebase ì—°ê²° ì‹œë„ ì¤‘...</div>

    <div class="stats">
        <div class="stat-card">
            <h3 id="totalPlayers">0</h3>
            <p>ì „ì²´ ì°¸ê°€ì</p>
        </div>
        <div class="stat-card stage1">
            <h3 id="stage1Count">0</h3>
            <p>1ë‹¨ê³„ í†µê³¼</p>
        </div>
        <div class="stat-card stage2">
            <h3 id="stage2Count">0</h3>
            <p>2ë‹¨ê³„ í†µê³¼</p>
        </div>
        <div class="stat-card stage3">
            <h3 id="stage3Count">0</h3>
            <p>ğŸ† 3ë‹¨ê³„ í†µê³¼</p>
        </div>
    </div>

    <h3>ğŸ“ ì§„í–‰ ë‹¨ê³„ í˜„í™©</h3>
    <p class="small">ê° í‘œì˜ ì‹œê°„ì€ í•´ë‹¹ ë‹¨ê³„ì— <strong>ë§ˆì§€ë§‰ìœ¼ë¡œ ë„ë‹¬í•œ ì‹œê°</strong>(HH:MM)ì…ë‹ˆë‹¤.</p>

    <h4>1ë‹¨ê³„ í†µê³¼ì</h4>
    <table class="table">
        <thead>
            <tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì™„ë£Œ ì‹œê°„</th></tr>
        </thead>
        <tbody id="stage1Body">
            <tr><td colspan="3">ì—†ìŒ</td></tr>
        </tbody>
    </table>

    <h4>2ë‹¨ê³„ í†µê³¼ì</h4>
    <table class="table">
        <thead>
            <tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì™„ë£Œ ì‹œê°„</th></tr>
        </thead>
        <tbody id="stage2Body">
            <tr><td colspan="3">ì—†ìŒ</td></tr>
        </tbody>
    </table>

    <h4>ğŸ† 3ë‹¨ê³„ í†µê³¼ì ğŸ†</h4>
    <table class="table">
        <thead>
            <tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì™„ë£Œ ì‹œê°„</th></tr>
        </thead>
        <tbody id="stage3Body">
            <tr><td colspan="3">ì—†ìŒ</td></tr>
        </tbody>
    </table>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    var firebaseConfig = {
        apiKey: "AIzaSyBeC5C9NYZVO3c5MZrTeUfpFjCnW059bDQ",
        authDomain: "selab-party.firebaseapp.com",
        databaseURL: "https://selab-party-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "selab-party"
    };
    var db = null;

    function init() {
        var connStatus = document.getElementById("connStatus");

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            connStatus.textContent = "âœ… Firebase ì—°ê²°ë¨";
            connStatus.classList.add("conn-ok");
            setupListeners();
        } catch (e) {
            connStatus.textContent = "âŒ Firebase ì—°ê²° ì‹¤íŒ¨: " + e.message;
            connStatus.classList.add("conn-error");
        }
    }

    function formatTime(isoString) {
        if (!isoString) return "-";
        var d = new Date(isoString);
        if (isNaN(d.getTime())) return "-";
        var h = d.getHours();
        var m = String(d.getMinutes()).padStart(2, "0");
        return h + ":" + m;
    }

    function setupListeners() {
        if (!db) return;

        db.ref("players").on("value", function(s) {
            var d = s.val();
            var stage1Body = document.getElementById("stage1Body");
            var stage2Body = document.getElementById("stage2Body");
            var stage3Body = document.getElementById("stage3Body");

            if (!d) {
                document.getElementById("totalPlayers").textContent = '0';
                document.getElementById("stage1Count").textContent = '0';
                document.getElementById("stage2Count").textContent = '0';
                document.getElementById("stage3Count").textContent = '0';
                stage1Body.innerHTML = '<tr><td colspan="3">ì—†ìŒ</td></tr>';
                stage2Body.innerHTML = '<tr><td colspan="3">ì—†ìŒ</td></tr>';
                stage3Body.innerHTML = '<tr><td colspan="3">ì—†ìŒ</td></tr>';
                return;
            }

            var totalPlayers = 0;
            var stage1List = [];
            var stage2List = [];
            var stage3List = [];

            for (var k in d) {
                var p = d[k];
                totalPlayers++;
                var stage = p.stage || 0;
                if (stage === 1) stage1List.push(p);
                else if (stage === 2) stage2List.push(p);
                else if (stage === 3) stage3List.push(p);
            }

            document.getElementById("totalPlayers").textContent = totalPlayers;
            document.getElementById("stage1Count").textContent = stage1List.length;
            document.getElementById("stage2Count").textContent = stage2List.length;
            document.getElementById("stage3Count").textContent = stage3List.length;

            function sortByTime(list) {
                list.sort(function(a,b){
                    var ta = a.lastUpdate || a.joinedAt || '';
                    var tb = b.lastUpdate || b.joinedAt || '';
                    return new Date(ta) - new Date(tb);
                });
            }
            sortByTime(stage1List);
            sortByTime(stage2List);
            sortByTime(stage3List);

            function renderStage(bodyEl, list) {
                if (!list.length) {
                    bodyEl.innerHTML = '<tr><td colspan="3">ì—†ìŒ</td></tr>';
                    return;
                }
                var _h = "";
                for (var i=0;i<list.length;i++) {
                    var p = list[i];
                    var tIso = p.lastUpdate || p.joinedAt || "";
                    var timeText = formatTime(tIso);
                    _h += '<tr>' +
                          '<td>' + (i+1) + '</td>' +
                          '<td>' + (p.name || '-') + '</td>' +
                          '<td>' + timeText + '</td>' +
                          '</tr>';
                }
                bodyEl.innerHTML = _h;
            }

            renderStage(stage1Body, stage1List);
            renderStage(stage2Body, stage2List);
            renderStage(stage3Body, stage3List);
        });
    }

    window.onload = function() {
        setTimeout(init, 200);
    };
</script>
</body>
</html>